<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ 'Edit User' if result.user_id else 'Add User' }}</title>
    {% include 'head.html' %}
    <style>
        .card {
            max-width: 800px;
            margin: 50px auto;
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .card-header {
            background-color: #fff;
            border-bottom: 1px solid #dee2e6;
            border-radius: 12px 12px 0 0;
            text-align: center;
            padding: 20px;
        }
        .card-body {
            padding: 30px;
            background-color: #fff;
        }
        .btn-dark {
            background-color: #212529;
            border-color: #212529;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: bold;
        }
        .btn-dark:hover {
            background-color: #343a40;
            border-color: #343a40;
        }
        .form-control, .form-select {
            border-radius: 6px;
        }
        .input-group-text {
            border-radius: 6px 0 0 6px;
        }
        .current-sign-img {
            max-width: 150px;
            border-radius: 6px;
            margin-top: 10px;
        }
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .form-row .mb-3 {
            flex: 1 1 45%;
            min-width: 200px;
        }
    </style>
</head>
<body>
    {% include 'navbar.html' %}
    {% import 'breadcrumbs.html' as brd %}
    {{ brd.render_Breadcrumbs([{"url": 'manage_users', "label": "Manage Users"}, {"url": "", "label": 'Edit User' if result.user_id else 'Add User' }]) }}

    <div class="container">
        {% include 'message_box.html' %}

        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">{{ 'Edit User' if result.user_id else 'Add User' }}</h4>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('add_edit_user', user_id=result.user_id) if result.user_id else url_for('add_edit_user') }}" enctype="multipart/form-data">
                    <div class="form-row">
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control" name="name" value="{{ result.user.name if result.user else '' }}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                                <input type="email" class="form-control" name="email" value="{{ result.user.email if result.user else '' }}" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="mb-3">
                            <label class="form-label">Rights</label>
                            <select class="form-select" name="rights" id="rights" required>
                                <option value="" disabled {{ 'selected' if not result.user else '' }}>[Select...]</option>
                                <option value="1" {{ 'selected' if result.user and result.user.rights == 1 else '' }}>Reviewer</option>
                                <option value="2" {{ 'selected' if result.user and result.user.rights == 2 else '' }}>Approver</option>
                                <option value="3" {{ 'selected' if result.user and result.user.rights == 3 else '' }}>Executive Approver</option>
                                <option value="4" {{ 'selected' if result.user and result.user.rights == 4 else '' }}>Administrator</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Gender</label>
                            <select class="form-select" name="gender">
                                <option value="" {{ 'selected' if not result.user or not result.user.gender else '' }}>[Select...]</option>
                                <option value="Male" {{ 'selected' if result.user and result.user.gender == 'Male' else '' }}>Male</option>
                                <option value="Female" {{ 'selected' if result.user and result.user.gender == 'Female' else '' }}>Female</option>
                                <option value="Other" {{ 'selected' if result.user and result.user.gender == 'Other' else '' }}>Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="mb-3">
                            <label class="form-label">Date of Birth</label>
                            <input type="date" class="form-control" name="dob" value="{{ result.user.dob if result.user else '' }}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" name="phone" value="{{ result.user.phone if result.user else '' }}" placeholder="e.g., +1234567890">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="mb-3">
                            <label class="form-label">Country of Residence</label>
                            <input type="text" class="form-control" name="country_of_residence" value="{{ result.user.country_of_residence if result.user else '' }}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Date of Joining</label>
                            <input type="date" class="form-control" name="date_of_joining" value="{{ result.user.date_of_joining if result.user else '' }}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="mb-3">
                            <label class="form-label">Orientation Completed On</label>
                            <input type="date" class="form-control" name="orientation_completed_on" value="{{ result.user.orientation_completed_on if result.user else '' }}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Manager</label>
                            <select class="form-select" name="manager_id" id="manager_id">
                                <option value="" {{ 'selected' if not result.user or not result.user.manager_id else '' }}>[Select...]</option>
                                {% for user in result.get_all_user_data %}
                                    {% if user['user_id'] != result.user_id %}
                                        <option value="{{ user['volunteer_id'] }}" {{ 'selected' if result.user and result.user.manager_id|int == user['volunteer_id']|int else '' }}>{{ user['volunteer_id'] }} - {{ user['name'] }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="mb-3">
                            <label class="form-label">Assigned Branch</label>
                            <select class="form-select" name="assigned_branch">
                                <option value="" {{ 'selected' if not result.user or not result.user.assigned_branch else '' }}>[Select...]</option>
                                {% for branch in result.get_all_branches_info %}
                                    <option value="{{ branch['branch_id'] }}" {{ 'selected' if result.user and result.user.assigned_branch == branch['branch_id'] else '' }}>{{ branch['branch_name'] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Volunteer ID</label>
                            <input type="text" class="form-control" name="volunteer_id" value="{{ result.user.volunteer_id if result.user else 'Auto-generated' }}" readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="mb-3">
                            <label class="form-label">Signature</label>
                            <select class="form-select" name="signature" required>
                                <option value="1" {{ 'selected' if result.user and result.user.signature == '1' else '' }}>Yes</option>
                                <option value="0" {{ 'selected' if result.user and result.user.signature == '0' else '' }}>No</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Scan Sign</label>
                            <input type="file" class="form-control" name="scan_sign" accept="image/*">
                            {% if result.user and result.user.scan_sign %}
                                <small class="form-text text-muted">Current signature:</small><br>
                                <img src="{{ url_for('get_user_signature', user_id=result.user_id) }}" alt="Current Signature" class="current-sign-img">
                            {% endif %}
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="mb-3">
                            <label class="form-label">Active</label>
                            <select class="form-select" name="active" id="ddl_active" required>
                                <option value="1" {{ 'selected' if result.user and result.user.active == '1' else '' }}>Yes</option>
                                <option value="0" {{ 'selected' if result.user and result.user.active == '0' else '' }}>No</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row div-dor-and-reason d-none">
                        <div class="mb-3">
                            <label class="form-label">Date of Retirement</label>
                            <input type="date" class="form-control" id="date_of_retirement" name="date_of_retirement" value="{{ result.user.date_of_retirement or '' }}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Reason</label>
                            <textarea class="form-control" id="reason" name="reason">{{ result.user.reason or '' }}</textarea>
                        </div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-dark">{{ 'Update User' if result.user_id else 'Add User' }}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Toggle 'required' attribute for manager_id based on rights selection
        document.getElementById('rights').addEventListener('change', function() {
            const managerIdSelect = document.getElementById('manager_id');
            if (this.value === '1') { // Reviewer
                managerIdSelect.setAttribute('required', 'required');
            } else {
                managerIdSelect.removeAttribute('required');
            }
        });

        // Set initial state on page load
        document.addEventListener('DOMContentLoaded', function() {
            const rightsSelect = document.getElementById('rights');
            const managerIdSelect = document.getElementById('manager_id');
            if (rightsSelect.value === '1') {
                managerIdSelect.setAttribute('required', 'required');
            } else {
                managerIdSelect.removeAttribute('required');
            }
        });
    </script>

    <script>
        $(document).ready(function(){
            $('#ddl_active').change(function(){
                let is_active = $(this).val() == '1' ? true : false;
                console.log(is_active)

                if(!is_active){
                    $('.div-dor-and-reason').removeClass('d-none');
                    $('#date_of_retirement').prop('required', true);
                    $('#reason').prop('required', true);
                }
                else{
                    $('.div-dor-and-reason').addClass('d-none');
                    $('#date_of_retirement').prop('required', false);
                    $('#reason').prop('required', false);
                }
            }).change();
        })
    </script>
</body>
</html>