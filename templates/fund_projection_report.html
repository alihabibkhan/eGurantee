<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fund Projection Report</title>
    {% include 'head.html' %}
    <style>
        .card {
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .readonly-field {
            background-color: #f8f9fa;
        }
        .calculation-field {
            font-weight: bold;
        }
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .table {
            width: 100%;
            min-width: 600px;
            border-collapse: collapse;
        }
        .table th, .table td {
            border: 1px solid #dee2e6;
            padding: 0.75rem;
            text-align: center;
            white-space: nowrap;
        }
        .table th {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    {% include 'navbar.html' %}
    {% import 'breadcrumbs.html' as brd %}
    {{ brd.render_Breadcrumbs([{"url":"", "label":"Fund Projection Report"}]) }}

    <div class="mt-3">
        {% include 'message_box.html' %}
    </div>

    <div class="container py-4">
        <h1 class="mb-4">Fund Projection Report</h1>

        <!-- Collateral Account Projection -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Collateral Account Projection</h5>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="bank-select">Bank</label>
                    <select id="bank-select" class="form-control">
                        <option value="">Select a Bank</option>
                        {% for bank in result.get_all_bank_details %}
                            <option value="{{ bank.bank_id }}"
                                    data-balance="{% for entry in result.get_all_banks_last_entry_records %}{% if entry.bank_id == bank.bank_id %}{{ entry.balance }}{% endif %}{% endfor %}">
                                {{ bank.bank_code }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="account-balance">Account Balance</label>
                    <input type="text" id="account-balance" class="form-control readonly-field" readonly>
                </div>
                <div class="form-group">
                    <label for="actual-data-date">Actual Data - Recent Updated on</label>
                    <input type="text" id="actual-data-date" class="form-control readonly-field" value="{{ result.get_outstanding_loans[0].Latest_Month | default('N/A') }}" readonly>
                </div>
                <div class="form-group">
                    <label for="report-date">Report Date</label>
                    <input type="text" id="report-date" class="form-control readonly-field" value="Mar 5, 2025" readonly>
                </div>
            </div>
        </div>

        <!-- Collateral Account Current Position -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Collateral Account Current Position</h5>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="actual-portfolio">Actual Portfolio - Loan Outstanding</label>
                    <input type="text" id="actual-portfolio" class="form-control readonly-field" value="{{ '%.3f'|format(result.get_outstanding_loans[0].total_principal_outstanding) | default('0') }}" readonly>
                </div>
                <div class="form-group">
                    <label for="ten-percent-lien">10% Lien Amount</label>
                    <input type="text" id="ten-percent-lien" class="form-control readonly-field calculation-field" readonly>
                </div>
                <div class="form-group">
                    <label for="total-lien-amount">Total Lien Amount</label>
                    <input type="text" id="total-lien-amount" class="form-control readonly-field calculation-field" readonly>
                </div>
                <div class="form-group">
                    <label for="actual-collateral-balance">Actual Collateral Account Balance</label>
                    <input type="text" id="actual-collateral-balance" class="form-control readonly-field" readonly>
                </div>
                <div class="form-group">
                    <label for="surplus-shortfall">Surplus / (Shortfall)</label>
                    <input type="text" id="surplus-shortfall" class="form-control readonly-field calculation-field" readonly>
                </div>
            </div>
        </div>

        <!-- Projected Disbursement -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Projected Disbursement (Based on Past Averages)</h5>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="projected-disbursement">Projected Disbursement (Based on Past Averages)</label>
                    <input type="number" id="projected-disbursement" class="form-control" value="0">
                </div>
                <div class="form-group">
                    <label for="seasonal-affects">Add: Seasonal Affects if any</label>
                    <input type="number" id="seasonal-affects" class="form-control" value="0">
                </div>
                <div class="form-group">
                    <label for="new-product-affects">Add: New Product / Area Launch affects if any</label>
                    <input type="number" id="new-product-affects" class="form-control" value="0">
                </div>
                <div class="form-group">
                    <label for="projected-recoveries">Less: Projected Recoveries</label>
                    <input type="text" id="projected-recoveries" class="form-control readonly-field calculation-field" readonly>
                </div>
                <div class="form-group">
                    <label for="projected-monthly-change">Projected Monthly Change (Inc / Dec)</label>
                    <input type="text" id="projected-monthly-change" class="form-control readonly-field calculation-field" readonly>
                </div>
            </div>
        </div>

        <!-- Projected Funds Requirement -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Projected Funds Requirement</h5>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="actual-portfolio-opening">Actual Portfolio - Loan Outstanding (Opening)</label>
                    <input type="text" id="actual-portfolio-opening" class="form-control readonly-field" value="{{ '%.3f'|format(result.get_outstanding_loans[0].total_principal_outstanding) | default('0') }}" readonly>
                </div>
                <div class="form-group">
                    <label for="add-projected-monthly-change">Add Projected Monthly Change</label>
                    <input type="text" id="add-projected-monthly-change" class="form-control readonly-field" readonly>
                </div>
                <div class="form-group">
                    <label for="projected-portfolio-closing">Projected Portfolio - Loan Outstanding (Closing)</label>
                    <input type="text" id="projected-portfolio-closing" class="form-control readonly-field calculation-field" readonly>
                </div>
                <div class="form-group">
                    <label for="cushion-ten-percent">Add: Cushion for 10% lien</label>
                    <input type="text" id="cushion-ten-percent" class="form-control readonly-field calculation-field" readonly>
                </div>
                <div class="form-group">
                    <label for="projected-collateral-balance">Projected Collateral Account Balance</label>
                    <input type="text" id="projected-collateral-balance" class="form-control readonly-field calculation-field" readonly>
                </div>
                <div class="form-group">
                    <label for="actual-collateral-balance-req">Actual Collateral Account Balance</label>
                    <input type="text" id="actual-collateral-balance-req" class="form-control readonly-field" readonly>
                </div>
                <div class="form-group">
                    <label for="surplus-shortfall-req">Surplus / (Shortfall)</label>
                    <input type="text" id="surplus-shortfall-req" class="form-control readonly-field calculation-field" readonly>
                </div>
            </div>
        </div>

        <!-- Loan Disbursement Trend Analysis -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Loan Disbursement Trend Analysis</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead id="disbursement-table-head">
                            <tr>
                                <th>Months</th>
                            </tr>
                        </thead>
                        <tbody id="disbursement-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data from Flask
        const outstandingLoans = {{ result.get_outstanding_loans | tojson }};
        const totalPrincipalOutstanding = outstandingLoans[0]?.total_principal_outstanding || 0;
        const disbursementData = {{ result.post_disbursement_by_booked_on | tojson }};

        // Update account balance on bank selection
        document.getElementById('bank-select').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const balance = selectedOption.dataset.balance || '0';
            document.getElementById('account-balance').value = balance;
            document.getElementById('actual-collateral-balance').value = balance;
            document.getElementById('actual-collateral-balance-req').value = balance;
            updateCalculations();
            updateDisbursementTable();
        });

        // Update calculations
        function updateCalculations() {
            const actualPortfolio = parseFloat(totalPrincipalOutstanding) || 0;
            const tenPercentLien = actualPortfolio * 0.1;
            const totalLienAmount = actualPortfolio + tenPercentLien;
            const actualCollateralBalance = parseFloat(document.getElementById('actual-collateral-balance').value) || 0;
            const surplusShortfall = actualCollateralBalance - totalLienAmount;

            const projectedDisbursement = parseFloat(document.getElementById('projected-disbursement').value) || 0;
            const seasonalAffects = parseFloat(document.getElementById('seasonal-affects').value) || 0;
            const newProductAffects = parseFloat(document.getElementById('new-product-affects').value) || 0;
            const projectedRecoveries = actualPortfolio / 36;
            const projectedMonthlyChange = projectedDisbursement + seasonalAffects + newProductAffects + projectedRecoveries;

            // Projected Funds Requirement calculations
            const actualPortfolioOpening = actualPortfolio;
            const projectedPortfolioClosing = actualPortfolioOpening + projectedMonthlyChange;
            const cushionTenPercent = projectedPortfolioClosing * 0.1;
            const projectedCollateralBalance = projectedPortfolioClosing + cushionTenPercent;
            const surplusShortfallReq = actualCollateralBalance - projectedCollateralBalance;

            // Update Collateral Account Current Position
            document.getElementById('ten-percent-lien').value = tenPercentLien.toFixed(2);
            document.getElementById('total-lien-amount').value = totalLienAmount.toFixed(2);
            document.getElementById('surplus-shortfall').value = surplusShortfall.toFixed(2);
            document.getElementById('projected-recoveries').value = projectedRecoveries.toFixed(2);
            document.getElementById('projected-monthly-change').value = projectedMonthlyChange.toFixed(2);

            // Update Projected Funds Requirement
            document.getElementById('add-projected-monthly-change').value = projectedMonthlyChange.toFixed(2);
            document.getElementById('projected-portfolio-closing').value = projectedPortfolioClosing.toFixed(2);
            document.getElementById('cushion-ten-percent').value = cushionTenPercent.toFixed(2);
            document.getElementById('projected-collateral-balance').value = projectedCollateralBalance.toFixed(2);
            document.getElementById('surplus-shortfall-req').value = surplusShortfallReq.toFixed(2);
        }

        // Update disbursement table
        function updateDisbursementTable() {
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const tableHead = document.getElementById('disbursement-table-head');
            const tableBody = document.getElementById('disbursement-table-body');

            // Extract unique years from disbursementData
            const years = [...new Set(disbursementData.map(item => Number(item.year)))].filter(year => !isNaN(year)).sort((a, b) => a - b);

            // Get yearly data from the first record of each year
            const yearDataSummary = {};
            years.forEach(year => {
                const firstRecord = disbursementData.find(item => Number(item.year) === year);
                if (firstRecord) {
                    yearDataSummary[year] = {
                        yearly_disbursement: Number(firstRecord.yearly_disbursement) || 0,
                        monthly_average: Number(firstRecord.monthly_average) || 0
                    };
                }
            });

            // Update table header dynamically
            tableHead.innerHTML = '<tr><th>Months</th>' + years.map(year => `<th>${year}</th>`).join('') + '</tr>';

            // Organize monthly disbursement data by year and month
            const yearData = {};
            disbursementData.forEach(item => {
                const year = Number(item.year);
                if (!yearData[year]) yearData[year] = {};
                if (item.month) {
                    yearData[year][item.month] = Number(item.monthly_disbursement) || 0;
                }
            });

            // Update table body
            tableBody.innerHTML = '';
            months.forEach(month => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${month}</td>` +
                    years.map(year => `<td>${yearData[year]?.[month]?.toFixed(2) || '0.00'}</td>`).join('');
                tableBody.appendChild(row);
            });

            // Add Yearly Disbursement row
            const yearlyRow = document.createElement('tr');
            yearlyRow.innerHTML = `<td>Yearly Disbursement</td>` +
                years.map(year => `<td>${yearDataSummary[year]?.yearly_disbursement?.toFixed(2) || '0.00'}</td>`).join('');
            tableBody.appendChild(yearlyRow);

            // Add Monthly Average Disbursement row
            const avgRow = document.createElement('tr');
            avgRow.innerHTML = `<td>Monthly Average Disbursement</td>` +
                years.map(year => `<td>${yearDataSummary[year]?.monthly_average?.toFixed(2) || '0.00'}</td>`).join('');
            tableBody.appendChild(avgRow);
        }

        // Add event listeners for input fields
        document.getElementById('projected-disbursement').addEventListener('input', updateCalculations);
        document.getElementById('seasonal-affects').addEventListener('input', updateCalculations);
        document.getElementById('new-product-affects').addEventListener('input', updateCalculations);

        // Initial calculations and table update
        updateCalculations();
        updateDisbursementTable();
    </script>
</body>
</html>