<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Announcements</title>
    {% include 'head.html' %}
    <style>
        .table-responsive { margin-bottom: 1rem; }
        .pagination .page-item.active .page-link { background-color: #0d6efd; border-color: #0d6efd; }
        .pagination .page-item.disabled .page-link { cursor: not-allowed; opacity: 0.65; }
        .card { margin-top: 1rem; }
        .action-icons a, .action-icons button { margin-right: 0.5rem; border: none; background: none; cursor: pointer; }
        .add-button { margin-bottom: 1rem; }
        .priority-badge { min-width: 45px; text-align: center; font-size: 0.875rem; }
        .color-preview { width: 24px; height: 24px; border-radius: 4px; border: 1px solid #ddd; display: inline-block; margin-right: 8px; }
    </style>
</head>
<body>
    {% include 'navbar.html' %}
    {% import 'breadcrumbs.html' as brd %}
    {{ brd.render_Breadcrumbs([{"url":"", "label":"Manage Announcements"}]) }}

    <div class="mt-3">
        {% include 'message_box.html' %}
    </div>

    <div class="container py-4">
        <a href="{{ url_for('add_edit_announcement') }}" class="btn btn-primary add-button mb-3">+ Add New Announcement</a>

        <h1 class="mb-4">Manage Announcements</h1>

        <!-- Data Table Card -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Announcements</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover text-nowrap">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">Priority</th>
                                <th scope="col">Title</th>
                                <th scope="col">Message Preview</th>
                                <th scope="col">Active</th>
                                <th scope="col">Start Date</th>
                                <th scope="col">End Date</th>
                                <th scope="col">Colors</th>
                                <th scope="col">Created</th>
                                <th scope="col">Action</th>
                            </tr>
                        </thead>
                        <tbody id="announcements-table-body"></tbody>
                    </table>
                </div>
                <nav aria-label="Announcements pagination">
                    <ul class="pagination justify-content-center" id="announcements-pagination"></ul>
                </nav>
            </div>
        </div>
    </div>

    <script>
        // Data from Flask - exactly matching PG schema
        const announcementsData = {{ result.announcements | tojson }};
        const itemsPerPage = 10;
        let currentPage = 1;
        let filteredData = announcementsData;

        // Format date (handles PG TIMESTAMP)
        function formatDate(dateStr) {
            if (!dateStr) return 'Never';
            const date = new Date(dateStr);
            return isNaN(date.getTime()) ? dateStr : date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        // Render table rows
        function renderTable(data, tableBodyId, page) {
            const tbody = document.getElementById(tableBodyId);
            tbody.innerHTML = '';
            const start = (page - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = data.slice(start, end);

            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4">No announcements found. <a href="{{ url_for("add_edit_announcement") }}">Create one now!</a></td></tr>';
                return;
            }

            pageData.forEach(record => {
                const row = document.createElement('tr');
                const isActive = record.is_active === true || record.is_active == 1;
                row.innerHTML = `
                    <td><span class="badge ${record.priority > 50 ? 'bg-danger' : record.priority > 20 ? 'bg-warning' : 'bg-secondary'} priority-badge">${record.priority || 0}</span></td>
                    <td class="fw-semibold text-truncate" style="max-width: 180px;" title="${record.title || 'N/A'}">${record.title || 'N/A'}</td>
                    <td class="text-truncate" style="max-width: 300px;" title="${record.message || 'N/A'}">${(record.message || 'N/A').substring(0, 60)}${record.message && record.message.length > 60 ? '...' : ''}</td>
                    <td><span class="badge ${isActive ? 'bg-success' : 'bg-danger'}">${isActive ? 'Yes' : 'No'}</span></td>
                    <td>${formatDate(record.start_date)}</td>
                    <td>${formatDate(record.end_date)}</td>
                    <td>
                        <span class="color-preview" style="background-color: ${record.background_color || '#9b2ab8'};"></span>
                        <span class="color-preview" style="background-color: ${record.text_color || '#ffffff'}; color: ${record.text_color || '#ffffff'};"></span>
                    </td>
                    <td>${formatDate(record.created_at)}</td>
                    <td class="action-icons">
                        <a href="/edit-announcement/${record.id}" title="Edit">
                            <i class="bi bi-pencil text-primary"></i>
                        </a>
                        <form action="/delete-announcement/${record.id}" method="POST" style="display:inline;" onsubmit="return confirm('delete ${record.title} announcement?')">
                            <button type="submit" title="Delete" class="text-danger">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </form>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Pagination (exact copy from your bank details page)
        function renderPagination(data, paginationId, page) {
            const pagination = document.getElementById(paginationId);
            pagination.innerHTML = '';
            const totalPages = Math.ceil(data.length / itemsPerPage);
            if (totalPages <= 1) return;

            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${page === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" ${page === 1 ? '' : `onclick="changePage(${page - 1}); return false;"`}>Previous</a>`;
            pagination.appendChild(prevLi);

            // Page numbers with ellipsis (exact logic from your bank page)
            const maxVisiblePages = 5;
            let startPage = Math.max(1, page - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            if (startPage > 1) {
                const firstLi = document.createElement('li');
                firstLi.className = 'page-item';
                firstLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(1); return false;">1</a>`;
                pagination.appendChild(firstLi);
                if (startPage > 2) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = '<span class="page-link">...</span>';
                    pagination.appendChild(ellipsisLi);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === page ? 'active' : ''}`;
                pageLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>`;
                pagination.appendChild(pageLi);
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = '<span class="page-link">...</span>';
                    pagination.appendChild(ellipsisLi);
                }
                const lastLi = document.createElement('li');
                lastLi.className = 'page-item';
                lastLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${totalPages}); return false;">${totalPages}</a>`;
                pagination.appendChild(lastLi);
            }

            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${page === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" ${page === totalPages ? '' : `onclick="changePage(${page + 1}); return false;"`}>Next</a>`;
            pagination.appendChild(nextLi);
        }

        function changePage(page) {
            currentPage = page;
            renderTable(filteredData, 'announcements-table-body', currentPage);
            renderPagination(filteredData, 'announcements-pagination', currentPage);
        }

        // Initial render with debug
        console.log('Announcements data loaded:', announcementsData.length, 'records');
        renderTable(filteredData, 'announcements-table-body', currentPage);
        renderPagination(filteredData, 'announcements-pagination', currentPage);
    </script>
</body>
</html>