<!DOCTYPE html>
<html lang="en">
<head>
    {% include 'head.html' %}
    <title>Manage Branches</title>
    <style>
        .table-responsive {
            margin-bottom: 1rem;
        }
        .card {
            margin-top: 1rem;
        }
        .action-icons a {
            margin-right: 8px;
            cursor: pointer;
        }
        .add-branch-btn {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    {% include 'navbar.html' %}
    {% import 'breadcrumbs.html' as brd %}
    {{ brd.render_Breadcrumbs([{"url": "", "label": "Manage Branches"}]) }}

    <div class="container mt-4">
        {% include 'message_box.html' %}

        <div class="card">
            <div class="card-header">
                <h2>Manage Branches</h2>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="branchTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="branches-tab" data-bs-toggle="tab" data-bs-target="#branches" href="#branches" role="tab" aria-controls="branches" aria-selected="true">Branches</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="bank-distributions-tab" data-bs-toggle="tab" href="#bank-distributions" data-bs-target="#bank-distributions" role="tab" aria-controls="bank-distributions" aria-selected="false">Bank Distributions</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="national-council-distributions-tab" data-bs-toggle="tab" href="#national-council-distributions" data-bs-target="#national-council-distributions" role="tab" aria-controls="national-council-distributions" aria-selected="false">National Council Distributions</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="kft-distributions-tab" data-bs-toggle="tab" href="#kft-distributions" data-bs-target="#kft-distributions" role="tab" aria-controls="kft-distributions" aria-selected="false">KFT Distributions</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="branch-roles-tab" data-bs-toggle="tab" href="#branch-roles" data-bs-target="#branch-roles" role="tab" aria-controls="branch-roles" aria-selected="false">Branch Roles</a>
                    </li>
                </ul>

                <div class="tab-content" id="branchTabContent">
                    <!-- Branches Tab -->
                    <div class="tab-pane fade show active" id="branches" role="tabpanel" aria-labelledby="branches-tab">
                        <h3 class="mt-3">Branches</h3>
                        <a href="{{ url_for('add_edit_branch') }}" class="btn btn-primary mb-3">Add Branch</a>
                        <div class="table-responsive">
                            <table class="table tbl_records text-nowrap text-center table-responsive table-responsive-sm table-responsive-md table-responsive-lg table-responsive-xl table-responsive-xxl m-auto table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th>Branch Code</th>
                                        <th>Role</th>
                                        <th>Branch Name</th>
                                        <th>Area</th>
                                        <th>Created By</th>
                                        <th>Created Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for branch in result.get_all_branches_info %}
                                    <tr>
                                        <td>{{ branch.branch_code or '' }}</td>
                                        <td>{{ branch.role or '' }}</td>
                                        <td>{{ branch.branch_name or '' }}</td>
                                        <td>{{ branch.area or '' }}</td>
                                        <td>{{ branch.createdby or '' }}</td>
                                        <td>{{ branch.created_date|format_date }}</td>
                                        <td>
                                            <a href="#" class="text-decoration-none" title="View" data-bs-toggle="modal" data-bs-target="#branchDetailModal" onclick="showBranchDetails('{{ branch.branch_id }}')">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <a href="{{ url_for('add_edit_branch', branch_id=branch.branch_id) }}" class="text-decoration-none" title="Edit">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <a href="{{ url_for('delete_branch', branch_id=branch.branch_id) }}" class="text-decoration-none" title="Delete" onclick="return confirm('Are you sure?')">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Bank Distributions Tab -->
                    <div class="tab-pane fade" id="bank-distributions" role="tabpanel" aria-labelledby="bank-distributions-tab">
                        <h3 class="mt-3">Bank Distributions</h3>
                        <a href="{{ url_for('add_edit_bank_distribution') }}" class="btn btn-primary mb-3">Add Bank Distribution</a>
                        <div class="table-responsive">
                            <table class="table tbl_records text-nowrap text-center table-responsive table-responsive-sm table-responsive-md table-responsive-lg table-responsive-xl table-responsive-xxl m-auto table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Active</th>
                                        <th>Created By</th>
                                        <th>Created Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for distribution in result.get_all_bank_distributions %}
                                    <tr>
                                        <td>{{ distribution.bank_distribution_name }}</td>
                                        <td>{{ 'Yes' if distribution.is_active == 1 else 'No' }}</td>
                                        <td>{{ distribution.created_by }}</td>
                                        <td>{{ distribution.created_date|format_date }}</td>
                                        <td>
                                            <a href="{{ url_for('add_edit_bank_distribution', bank_distribution_id=distribution.bank_distribution_id) }}" class="text-decoration-none" title="Edit">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <a href="{{ url_for('delete_bank_distribution', bank_distribution_id=distribution.bank_distribution_id) }}" class="text-decoration-none" title="Delete" onclick="return confirm('Are you sure?')">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- National Council Distributions Tab -->
                    <div class="tab-pane fade" id="national-council-distributions" role="tabpanel" aria-labelledby="national-council-distributions-tab">
                        <h3 class="mt-3">National Council Distributions</h3>
                        <a href="{{ url_for('add_edit_national_council_distribution') }}" class="btn btn-primary mb-3">Add National Council Distribution</a>
                        <div class="table-responsive">
                            <table class="table tbl_records text-nowrap text-center table-responsive table-responsive-sm table-responsive-md table-responsive-lg table-responsive-xl table-responsive-xxl m-auto table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Active</th>
                                        <th>Created By</th>
                                        <th>Created Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for distribution in result.get_all_national_council_distributions %}
                                    <tr>
                                        <td>{{ distribution.national_council_distribution_name }}</td>
                                        <td>{{ 'Yes' if distribution.is_active == 1 else 'No' }}</td>
                                        <td>{{ distribution.created_by }}</td>
                                        <td>{{ distribution.created_date|format_date }}</td>
                                        <td>
                                            <a href="{{ url_for('add_edit_national_council_distribution', national_council_distribution_id=distribution.national_council_distribution_id) }}" class="text-decoration-none" title="Edit">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <a href="{{ url_for('delete_national_council_distribution', national_council_distribution_id=distribution.national_council_distribution_id) }}" class="text-decoration-none" title="Delete" onclick="return confirm('Are you sure?')">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- KFT Distributions Tab -->
                    <div class="tab-pane fade" id="kft-distributions" role="tabpanel" aria-labelledby="kft-distributions-tab">
                        <h3 class="mt-3">KFT Distributions</h3>
                        <a href="{{ url_for('add_edit_kft_distribution') }}" class="btn btn-primary mb-3">Add KFT Distribution</a>
                        <div class="table-responsive">
                            <table class="table tbl_records text-nowrap text-center table-responsive table-responsive-sm table-responsive-md table-responsive-lg table-responsive-xl table-responsive-xxl m-auto table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Active</th>
                                        <th>Created By</th>
                                        <th>Created Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for distribution in result.get_all_kft_distributions %}
                                    <tr>
                                        <td>{{ distribution.kft_distribution_name }}</td>
                                        <td>{{ 'Yes' if distribution.is_active == 1 else 'No' }}</td>
                                        <td>{{ distribution.created_by }}</td>
                                        <td>{{ distribution.created_date|format_date }}</td>
                                        <td>
                                            <a href="{{ url_for('add_edit_kft_distribution', kft_distribution_id=distribution.kft_distribution_id) }}" class="text-decoration-none" title="Edit">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <a href="{{ url_for('delete_kft_distribution', kft_distribution_id=distribution.kft_distribution_id) }}" class="text-decoration-none" title="Delete" onclick="return confirm('Are you sure?')">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Branch Roles Tab -->
                    <div class="tab-pane fade" id="branch-roles" role="tabpanel" aria-labelledby="branch-roles-tab">
                        <h3 class="mt-3">Branch Roles</h3>
                        <a href="{{ url_for('add_edit_branch_role') }}" class="btn btn-primary mb-3">Add Branch Role</a>
                        <div class="table-responsive">
                            <table class="table tbl_records text-nowrap text-center table-responsive table-responsive-sm table-responsive-md table-responsive-lg table-responsive-xl table-responsive-xxl m-auto table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Active</th>
                                        <th>Created By</th>
                                        <th>Created Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for role in result.get_all_branch_roles %}
                                    <tr>
                                        <td>{{ role.branch_role_name }}</td>
                                        <td>{{ 'Yes' if role.is_active == 1 else 'No' }}</td>
                                        <td>{{ role.created_by }}</td>
                                        <td>{{ role.created_date|format_date }}</td>
                                        <td>
                                            <a href="{{ url_for('add_edit_branch_role', branch_role_id=role.branch_role_id) }}" class="text-decoration-none" title="Edit">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <a href="{{ url_for('delete_branch_role', branch_role_id=role.branch_role_id) }}" class="text-decoration-none" title="Delete" onclick="return confirm('Are you sure?')">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Viewing Branch Details -->
    <div class="modal fade" id="branchDetailModal" tabindex="-1" aria-labelledby="branchDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="branchDetailModalLabel">Branch Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered">
                        <tbody id="branch-detail-body"></tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data from Flask with fallback
        const branchData = {{ result.get_all_branches_info | tojson | safe }} || [];

        // Validate data
        if (!Array.isArray(branchData)) {
            console.error('Invalid branch data:', branchData);
            const tbody = document.querySelector('#branches tbody');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Error loading data</td></tr>';
        }

        // Format date
        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return isNaN(date) ? dateStr : date.toLocaleDateString('en-US', { timeZone: 'Asia/Karachi' });
        }

        // Show branch details in modal
        function showBranchDetails(branchId) {
            // Find the record by branch_id
            const record = branchData.find(r => String(r.branch_id) === String(branchId));
            if (!record) {
                console.error('Branch not found for ID:', branchId);
                return;
            }

            const tbody = document.getElementById('branch-detail-body');
            tbody.innerHTML = '';
            const fields = [
                { key: 'bank_code', label: 'Bank Code' },
                { key: 'branch', label: 'Branch' },
                { key: 'branch_code', label: 'Branch Code' },
                { key: 'branch_name', label: 'Branch Name' },
                { key: 'area', label: 'Area' },
                { key: 'area_name', label: 'Area Name' },
                { key: 'role', label: 'Role' },
                { key: 'branch_manager', label: 'Branch Manager' },
                { key: 'email', label: 'Email' },
                { key: 'bank_distribution', label: 'Bank Distribution' },
                { key: 'national_council_distribution', label: 'National Council Distribution' },
                { key: 'kft_distribution', label: 'KFT Distribution' },
                { key: 'createdby', label: 'Created By' },
                { key: 'created_date', label: 'Created Date', format: formatDate }
            ];

            fields.forEach(field => {
                if (field.key !== 'branch_id') { // Exclude primary key
                    const row = document.createElement('tr');
                    const value = field.format ? field.format(record[field.key]) : (record[field.key] || 'N/A');
                    row.innerHTML = `
                        <th>${field.label}</th>
                        <td>${value}</td>
                    `;
                    tbody.appendChild(row);
                }
            });
        }

        // Handle tab navigation
        document.addEventListener("DOMContentLoaded", function () {
            // Activate tab if URL contains hash
            let hash = window.location.hash;
            if (hash) {
                let triggerEl = document.querySelector(`[data-bs-target="${hash}"]`);
                if (triggerEl) {
                    let tab = new bootstrap.Tab(triggerEl);
                    tab.show();
                }
            }

            // Update hash when tab is changed
            let tabLinks = document.querySelectorAll('a[data-bs-toggle="tab"]');
            tabLinks.forEach(function (el) {
                el.addEventListener("shown.bs.tab", function (event) {
                    let target = event.target.getAttribute("data-bs-target");
                    history.replaceState(null, null, target); // updates URL hash
                });
            });
        });
    </script>
</body>
</html>